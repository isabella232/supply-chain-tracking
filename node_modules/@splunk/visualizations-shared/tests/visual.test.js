/* eslint-env node */
import path from 'path';
import initStoryshots from '@storybook/addon-storyshots';
import { imageSnapshot } from '@storybook/addon-storyshots-puppeteer';

const storyKindRegex = process.env.VIZ_TYPE ? new RegExp(`^${process.env.VIZ_TYPE}$`) : null;

const beforeScreenshot = () =>
    new Promise(resolve =>
        setTimeout(() => {
            resolve();
        }, 200)
    );

const getGotoOptions = () => ({
    waitUntil: 'networkidle0',
});

const getMatchOptions = () => ({
    failureThreshold: 0,
    failureThresholdType: 'percent',
});

if (storyKindRegex) {
    // eslint-disable-next-line
    console.log('apply story filter regex', storyKindRegex);
}

initStoryshots({
    storyKindRegex,
    suite: 'visualizations shared',
    test: imageSnapshot({
        chromeExecutablePath: '/opt/google/chrome/google-chrome',
        beforeScreenshot,
        getGotoOptions,
        getMatchOptions,
        storybookUrl: `file:///${path.resolve(__dirname, '..', '.storybook-bundle')}`,
    }),
});
